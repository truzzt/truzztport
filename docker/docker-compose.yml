version: "3.8"

services:
  proxy:
    image: nginx:1.21.6
    volumes:
      - ../config/proxy/nginx.conf:/etc/nginx/templates/default.conf.template
    ports:
      - 13000:13000
      - 13001:13001
      - 13002:13002
      - 13003:13003
      - 13004:13004


  broker:
    image: federated-catalog
    networks:
      db:
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8181:8181"
    environment:
      EDC_FLYWAY_REPAIR: 'false'
      EDC_DATASOURCE_DEFAULT_URL: 'jdbc:postgresql://postgres:5432/broker'
      EDC_DATASOURCE_DEFAULT_USER: 'postgres'
      EDC_DATASOURCE_DEFAULT_PASSWORD: 'password'
      EDC_VAULT: /resources/vault/edc/vault.properties
      EDC_BROKER_BASE_URL: https://broker.test.mobility-dataspace.eu
      EDC_CLEARINGHOUSE_LOG_URL: https://clearing.test.mobility-dataspace.eu/messages/log
      EDC_KEYSTORE: /resources/vault/edc/keystore.jks
      EDC_KEYSTORE_PASSWORD: password
      EDC_OAUTH_PUBLIC_KEY_ALIAS: 1
      EDC_OAUTH_PRIVATE_KEY_ALIAS: 1
      EDC_OAUTH_CLIENT_ID: $SKI_AKI
      EDC_OAUTH_TOKEN_URL: https://daps.test.mobility-dataspace.eu/token
      EDC_OAUTH_PROVIDER_JWKS_URL: https://daps.test.mobility-dataspace.eu/jwks.json
      EDC_OAUTH_PROVIDER_AUDIENCE: idsc:IDS_CONNECTORS_ALL
  postgres:
    image: postgres:14-alpine
    networks:
      db:
        aliases:
          - postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: broker
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: "pg_isready --username=postgres && psql --username=postgres --list"
      timeout: 10s
      retries: 20
      start_period: 0s


  # broker-core:
  #   image: ghcr.io/truzzt/mds-broker-core:5.0.3
  #   environment:
  #     - SPARQL_ENDPOINT=http://fuseki:3030/connectorData
  #     - ELASTICSEARCH_HOSTNAME=elastic
  #     - SHACL_VALIDATION=true
  #     - DAPS_VALIDATE_INCOMING=false
  #     - IDENTITY_JAVAKEYSTORE=/etc/cert/keystore.jks
  #     - COMPONENT_URI=$BROKER_CORE_COMPONENT_URI
  #     - COMPONENT_CATALOGURI=$BROKER_CORE_COMPONENT_CATALOGURI
  #     - DAPS_URL=http://217.72.203.88:13000/token
  #   depends_on:
  #     - elastic
  #     - fuseki
  #   volumes:
  #     - ../data/cert/broker.local.jks:/etc/cert/keystore.jks

  # fuseki:
  #   image: registry.gitlab.cc-asp.fraunhofer.de/eis-ids/broker-open/fuseki
  #   volumes:
  #     - fuseki-data:/fuseki

  # elastic:
  #   image: elasticsearch:7.16.2
  #   environment:
  #     - http.port=9200
  #     - discovery.type=single-node
  #   volumes:      
  #     - elastic-data:/usr/share/elasticsearch/data

  # mongo:
  #   image: mongo:latest
  #   volumes:
  #     - mongo-data:/data/db

  # broker-backend:
  #   image: registry.gitlab.cc-asp.fraunhofer.de/eis-ids/broker/mongodb-handler:5.0.2-DF
  #   environment:
  #     - MONGODB_ENDPOINT=mongodb://mongo:27017/users
  #     - JWT_SECRET=$BROKER_BACKEND_JWT_SECRET
  #     - ADMIN_PASSWORD=$ADMIN_PASSWORD
  #     - BROKER_URL=http://broker-core:8080
  #   depends_on:
  #     - mongo
  
  # broker-frontend:
  #   image: registry.gitlab.cc-asp.fraunhofer.de/eis-ids/broker/frontend-mobids:5.0.2-DF
  #   environment:
  #     - REACT_APP_BROKER_URL=http://localhost:13002

  daps-core:
    image: ghcr.io/fraunhofer-aisec/omejdn-server:1.7.1
    environment:
      - OMEJDN_OPENID=true
      - OMEJDN_ACCEPT_AUDIENCE=idsc:IDS_CONNECTORS_ALL
      - OMEJDN_DEFAULT_AUDIENCE=idsc:IDS_CONNECTORS_ALL
      - OMEJDN_ADMIN=${DAPS_ADMIN_USERNAME}:${ADMIN_PASSWORD}
    volumes:
      - ../data/daps/clients.yml:/opt/config/clients.yml
      - ../config/daps:/opt/config
      - ../data/daps/clients/:/opt/keys/clients
      - ../data/cert/daps.local.key:/opt/keys/omejdn/omejdn.key

volumes:
  postgres-data:
  # mongo-data:
  # fuseki-data:
  # elastic-data:

networks:
  db:
    internal: true
    external: false
