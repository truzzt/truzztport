version: "3.8"

services:
  broker:
    image: ghcr.io/truzzt/mds-broker-core:5.0.3
    environment:
      - SPARQL_ENDPOINT=http://fuseki:3030/connectorData
      - ELASTICSEARCH_HOSTNAME=elastic
      - SHACL_VALIDATION=true
      - DAPS_VALIDATE_INCOMING=false
      - IDENTITY_JAVAKEYSTORE=/etc/cert/keystore.jks
      - COMPONENT_URI=https://broker.$TRUZZTPORT_ENV_SLUG.$TRUZZTPORT_BASE_DOMAIN
      - COMPONENT_CATALOGURI=https://broker.$TRUZZTPORT_ENV_SLUG.$TRUZZTPORT_BASE_DOMAIN/catalog/
      - DAPS_URL=hhttps://daps.$TRUZZTPORT_ENV_SLUG.$TRUZZTPORT_BASE_DOMAIN/token
    depends_on:
      - elastic
      - fuseki
    volumes:
      - ../data/$TRUZZTPORT_ENV_SLUG/broker/:/etc/cert/

  fuseki:
    image: registry.gitlab.cc-asp.fraunhofer.de/eis-ids/broker-open/fuseki
    volumes:
      - ../data/$TRUZZTPORT_ENV_SLUG/fuseki:/fuseki

  elastic:
    image: elasticsearch:7.16.2
    environment:
      - http.port=9200
      - discovery.type=single-node
    volumes:      
      - ../data/$TRUZZTPORT_ENV_SLUG/elastic:/usr/share/elasticsearch/data

  mongo:
    image: mongo:latest
    volumes:
      - ../data/$TRUZZTPORT_ENV_SLUG/mongo:/data/db

  daps:
    image: ghcr.io/fraunhofer-aisec/omejdn-server:1.7.1
    environment:
      - OMEJDN_OPENID=true
      - OMEJDN_ACCEPT_AUDIENCE=idsc:IDS_CONNECTORS_ALL
      - OMEJDN_DEFAULT_AUDIENCE=idsc:IDS_CONNECTORS_ALL
      - OMEJDN_ADMIN=${TRUZZTPORT_ADMIN_USERNAME}:${TRUZZTPORT_ADMIN_PASSWORD}
    volumes:
      - ../data/$TRUZZTPORT_ENV_SLUG/daps/config/:/opt/config/
      - ../data/$TRUZZTPORT_ENV_SLUG/daps/keys:/opt/keys/

  tc-core:
    image: ghcr.io/truzzt/truzztport/clearing:latest
    # tty: true
    # stdin_open: true
    volumes:
        - /var/run/docker.sock:/var/run/docker.sock
        - ../data/$TRUZZTPORT_ENV_SLUG/clearing/allow-all-flows.pl:/root/deploy/allow-all-flows.pl
        - ../data/$TRUZZTPORT_ENV_SLUG/clearing/keystore.p12:/root/etc/keystore.p12
        # - ../data/$TRUZZTPORT_ENV_SLUG/clearing/truststore.p12:/root/etc/truststore.p12
        - ../data/$TRUZZTPORT_ENV_SLUG/clearing/clearing-house-routes.xml:/root/deploy/clearing-house-routes.xml
    environment:
        TC_DAPS_URL: https://daps.$TRUZZTPORT_ENV_SLUG.$TRUZZTPORT_BASE_DOMAIN
        TC_CH_ISSUER_CONNECTOR: https://clearing.$TRUZZTPORT_ENV_SLUG.$TRUZZTPORT_BASE_DOMAIN
        TC_CH_AGENT: https://clearing.$TRUZZTPORT_ENV_SLUG.$TRUZZTPORT_BASE_DOMAIN

  keyring:
    image: ghcr.io/truzzt/truzztport/keyring:latest
    environment:
        - API_LOG_LEVEL=Info
    volumes:
        - ../data/$TRUZZTPORT_ENV_SLUG/clearing/keyring/init_db:/server/init_db
        - ../data/$TRUZZTPORT_ENV_SLUG/clearing/Rocket-keyring.toml:/server/Rocket.toml
        - ../data/$TRUZZTPORT_ENV_SLUG/clearing/daps.der:/server/certs/daps.der

  document:
    image: ghcr.io/truzzt/truzztport/document:latest
    depends_on:
        - keyring
    environment:
        - API_LOG_LEVEL=Info
    volumes:
        - ../data/$TRUZZTPORT_ENV_SLUG/clearing/Rocket-document.toml:/server/Rocket.toml
        - ../data/$TRUZZTPORT_ENV_SLUG/clearing/daps.der:/server/certs/daps.der

  logging:
    image: ghcr.io/truzzt/truzztport/logging:latest
    depends_on:
        - document
        - keyring
    environment:
        - API_LOG_LEVEL=Debug
    volumes:
        - ../data/$TRUZZTPORT_ENV_SLUG/clearing/Rocket-logging.toml:/server/Rocket.toml
        - ../data/$TRUZZTPORT_ENV_SLUG/clearing/keys:/server/keys
        - ../data/$TRUZZTPORT_ENV_SLUG/clearing/daps.der:/server/certs/daps.der
